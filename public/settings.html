<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إعدادات الحساب - مساند</title>
    <script src="https://cdn.tailwindcss.com"></script>
        <link href="css/styles.css" rel="stylesheet">
        <script>
            const base = '';
            async function fetchMe(){
                const r = await fetch('/auth/me', { credentials: 'include' });
                if(!r.ok) return null; return r.json();
            }
            async function postJSON(url, data){
                const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(data)});
                const txt = await r.text();
                try { return { ok: r.ok, data: JSON.parse(txt) }; } catch { return { ok: r.ok, data: { message: txt } }; }
            }
            document.addEventListener('DOMContentLoaded', async () => {
                const me = await fetchMe();
                if(!me){ window.location.href = '/auth/login'; return; }
                // تعبئة الحقول
                document.getElementById('firstName').value = me.firstName || '';
                document.getElementById('lastName').value = me.lastName || '';
                document.getElementById('username').value = me.username || '';
                document.getElementById('email').value = me.email || '';

                // حفظ الملف الشخصي
                document.getElementById('profileForm').addEventListener('submit', async (e)=>{
                    e.preventDefault();
                    const payload = {
                        firstName: document.getElementById('firstName').value.trim(),
                        lastName: document.getElementById('lastName').value.trim(),
                        username: document.getElementById('username').value.trim(),
                        email: document.getElementById('email').value.trim(),
                    };
                    const res = await postJSON('/settings/profile', payload);
                    alert(res.data.message || (res.ok ? 'تم الحفظ' : 'حدث خطأ'));
                });

                // تغيير كلمة المرور
                document.getElementById('passwordForm').addEventListener('submit', async (e)=>{
                    e.preventDefault();
                    const currentPassword = document.getElementById('currentPassword').value;
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    if(newPassword !== confirmPassword){ alert('تأكيد كلمة المرور غير مطابق'); return; }
                    const res = await postJSON('/settings/password', { currentPassword, newPassword });
                    alert(res.data.message || (res.ok ? 'تم التحديث' : 'حدث خطأ'));
                    if(res.ok){ document.getElementById('currentPassword').value=''; document.getElementById('newPassword').value=''; document.getElementById('confirmPassword').value=''; }
                });
            });
        </script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- Navbar موحد -->
    <nav class="bg-white shadow-sm w-full mb-8">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-8">
                <a href="/" class="logo text-2xl text-musanid-dark font-cairo font-bold tracking-wide">مساند</a>
                <div class="hidden md:flex gap-6">
                    <a href="/" class="nav-link text-gray-600 hover:text-musanid-dark transition">الرئيسية</a>
                    <a href="/dashboard" class="nav-link text-gray-600 hover:text-musanid-dark transition">لوحة التحكم</a>
                    <a href="/profile" class="nav-link text-gray-600 hover:text-musanid-dark transition">الملف الشخصي</a>
                    <a href="/settings" class="nav-link font-extrabold text-musanid-light border-b-2 border-musanid-light px-2">الإعدادات</a>
                    <a href="/faq" class="nav-link text-gray-600 hover:text-musanid-dark transition">الأسئلة الشائعة</a>
                    <a href="/about" class="nav-link text-gray-600 hover:text-musanid-dark transition">عن مساند</a>
                </div>
            </div>
            <div class="md:hidden">
                <button id="mobileMenuBtnSettings" class="text-gray-600 hover:text-musanid-dark focus:outline-none">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                    </svg>
                </button>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div id="mobileMenuSettings" class="hidden md:hidden px-4 pb-4">
            <div class="flex flex-col gap-2 bg-white rounded-lg shadow-lg mt-2 p-4">
                <a href="/" class="nav-link text-gray-600 hover:text-musanid-dark">الرئيسية</a>
                <a href="/dashboard" class="nav-link text-gray-600 hover:text-musanid-dark">لوحة التحكم</a>
                <a href="/profile" class="nav-link text-gray-600 hover:text-musanid-dark">الملف الشخصي</a>
                <a href="/settings" class="nav-link font-extrabold text-musanid-light border-b-2 border-musanid-light px-2">الإعدادات</a>
                <a href="/faq" class="nav-link text-gray-600 hover:text-musanid-dark">الأسئلة الشائعة</a>
                <a href="/about" class="nav-link text-gray-600 hover:text-musanid-dark">عن مساند</a>
            </div>
        </div>
    </nav>
    <script>
        // Mobile menu toggle for settings page
        (function() {
            const mobileMenuBtnSettings = document.getElementById('mobileMenuBtnSettings');
            const mobileMenuSettings = document.getElementById('mobileMenuSettings');
            if(mobileMenuBtnSettings && mobileMenuSettings) {
                mobileMenuBtnSettings.addEventListener('click', () => {
                    mobileMenuSettings.classList.toggle('hidden');
                });
                document.addEventListener('click', (e) => {
                    if (!mobileMenuBtnSettings.contains(e.target) && !mobileMenuSettings.contains(e.target)) {
                        mobileMenuSettings.classList.add('hidden');
                    }
                });
            }
        })();
    </script>
    <!-- إعدادات الحساب -->
    <main class="container mx-auto px-4 py-8 max-w-2xl flex-1">
        <h1 class="text-2xl font-bold text-musanid-dark mb-8">إعدادات الحساب</h1>
        <form id="profileForm" class="bg-white rounded-lg shadow-md p-6 space-y-6 mb-8">
            <!-- صورة الملف الشخصي -->
            <div class="flex flex-col items-center gap-2">
                <img src="https://ui-avatars.com/api/?name=مستخدم" alt="الصورة الشخصية" class="w-24 h-24 rounded-full border-2 border-musanid-light">
                <label class="block mt-2 text-gray-700 font-medium">تغيير الصورة الشخصية
                    <input type="file" class="hidden" accept="image/*">
                </label>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="firstName" class="block text-sm font-medium text-gray-700 mb-1">الاسم الأول</label>
                    <input id="firstName" name="firstName" type="text" class="input-field w-full" placeholder="الاسم الأول">
                </div>
                <div>
                    <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">اسم العائلة</label>
                    <input id="lastName" name="lastName" type="text" class="input-field w-full" placeholder="اسم العائلة">
                </div>
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">اسم المستخدم</label>
                    <input id="username" name="username" type="text" class="input-field w-full" placeholder="اسم المستخدم">
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">البريد الإلكتروني</label>
                    <input id="email" name="email" type="email" class="input-field w-full" placeholder="example@email.com">
                </div>
            </div>
            <div class="text-left">
                <button type="submit" class="btn-primary">حفظ التغييرات</button>
            </div>
        </form>

        <form id="passwordForm" class="bg-white rounded-lg shadow-md p-6 space-y-4">
            <h2 class="text-xl font-bold text-musanid-dark">تغيير كلمة المرور</h2>
            <div>
                <label for="currentPassword" class="block text-sm font-medium text-gray-700 mb-1">كلمة المرور الحالية</label>
                <input id="currentPassword" name="currentPassword" type="password" class="input-field w-full" placeholder="••••••••">
            </div>
            <div>
                <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-1">كلمة المرور الجديدة</label>
                <input id="newPassword" name="newPassword" type="password" class="input-field w-full" placeholder="••••••••">
            </div>
            <div>
                <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-1">تأكيد كلمة المرور</label>
                <input id="confirmPassword" name="confirmPassword" type="password" class="input-field w-full" placeholder="••••••••">
            </div>
            <div class="text-left">
                <button type="submit" class="btn-secondary">تحديث كلمة المرور</button>
            </div>
        </form>
    </main>
    <footer class="bg-gray-100 py-8">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-600">&copy; 2025 مساند. جميع الحقوق محفوظة</p>
        </div>
    </footer>
</body>
</html>
