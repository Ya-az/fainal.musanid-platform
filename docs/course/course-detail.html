<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³ - Ù…Ù†ØµØ© Ù…Ø³Ø§Ù†Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'musanid-dark': '#6D28D9',
                        'musanid-light': '#A78BFA',
                    }
                }
            }
        }
    </script>
    <link href="../css/styles.css" rel="stylesheet">
    <script defer src="../js/course-manager.js"></script>
    <script defer src="../js/certificate-manager.js"></script>
    <style>
        .progress-ring {
            transform: rotate(-90deg);
            transition: stroke-dasharray 0.35s;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
        }
        
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            border-radius: var(--radius-md);
        }
        
        .quiz-question {
            background: var(--color-neutral-50);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .quiz-option {
            padding: 0.75rem 1rem;
            border: 2px solid var(--color-neutral-200);
            border-radius: var(--radius-sm);
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .quiz-option:hover {
            border-color: var(--color-primary);
            background: rgba(var(--color-primary-rgb), 0.05);
        }
        
        .quiz-option.selected {
            border-color: var(--color-primary);
            background: rgba(var(--color-primary-rgb), 0.1);
        }
        
        .quiz-option.correct {
            border-color: var(--color-success);
            background: rgba(22, 163, 74, 0.1);
        }
        
        .quiz-option.incorrect {
            border-color: var(--color-error);
            background: rgba(220, 38, 38, 0.1);
        }

        .certificate-icon {
            width: 3.25rem;
            height: 3.25rem;
            border-radius: var(--radius-full);
            background: rgba(255, 255, 255, 0.2);
            display: grid;
            place-items: center;
            color: #FFFFFF;
            flex-shrink: 0;
        }

        .certificate-meta {
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            margin-top: var(--spacing-sm);
            padding-top: var(--spacing-sm);
            gap: 0.5rem;
        }

        .certificate-meta__row {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            font-size: 0.875rem;
        }

        .certificate-meta__row dd {
            font-weight: 600;
        }

        .certificate-modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            background: rgba(15, 23, 42, 0.6);
            z-index: 1000;
        }

        .certificate-modal.is-open {
            display: flex;
        }

        .certificate-modal__content {
            background: var(--color-neutral-0, #ffffff);
            border-radius: var(--radius-lg);
            box-shadow: 0 25px 50px -12px rgba(15, 23, 42, 0.25);
            max-width: 480px;
            width: 100%;
            padding: 2rem;
        }

        .certificate-modal__close {
            background: none;
            border: none;
            cursor: pointer;
            color: inherit;
        }

        body.has-modal-open {
            overflow: hidden;
        }
    </style>
</head>
<body>
    <header class="site-header" data-site-header data-base="../" data-active="courses" data-nav-id="courseDetailNav" data-home="index.html" data-primary-href="../auth/login.html"></header>

    <main>
        <!-- Course Header -->
        <section class="section">
            <div class="container">
                <div class="grid grid--columns-3 gap-lg">
                    <!-- Course Info -->
                    <div class="span-2">
                        <div class="layout-stack">
                            <div class="flex items-center gap-sm mb-md">
                                <a href="cr_index.html" class="btn btn-ghost">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="m15 18-6-6 6-6"/>
                                    </svg>
                                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¯ÙˆØ±Ø§Øª
                                </a>
                                <span class="badge" id="courseBadge">Ø´Ø¨ÙƒØ§Øª</span>
                            </div>
                            <h1 class="heading-xl" id="courseTitle">Ø£Ø³Ø§Ø³ÙŠØ§Øª Cisco Packet Tracer</h1>
                            <p class="text-lg text-muted" id="courseDescription">
                                Ø§Ø¨Ø¯Ø£ Ø¨Ø¨Ù†Ø§Ø¡ Ø´Ø¨ÙƒØ§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Packet Tracer ÙˆØªØ¹Ù„Ù… Ø¶Ø¨Ø· Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ© Ù…Ø¹ Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª Ø¹Ù…Ù„ÙŠØ©.
                            </p>
                            <div class="flex gap-md">
                                <div class="stat-mini">
                                    <span class="stat-mini__value" id="courseDuration">5</span>
                                    <span class="stat-mini__label">Ø£Ø³Ø§Ø¨ÙŠØ¹</span>
                                </div>
                                <div class="stat-mini">
                                    <span class="stat-mini__value" id="totalLessons">5</span>
                                    <span class="stat-mini__label">Ø¯Ø±ÙˆØ³</span>
                                </div>
                                <div class="stat-mini">
                                    <span class="stat-mini__value" id="courseLevel">Ù…Ø¨ØªØ¯Ø¦</span>
                                    <span class="stat-mini__label">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Progress Card -->
                    <div class="card layout-stack purple-section">
                        <h3 class="heading-md">Ø§Ù„ØªÙ‚Ø¯Ù… ÙÙŠ Ø§Ù„ÙƒÙˆØ±Ø³</h3>
                        <div class="flex items-center gap-md">
                            <div class="progress-circle">
                                <svg width="80" height="80" viewBox="0 0 80 80">
                                    <circle cx="40" cy="40" r="36" stroke="rgba(255,255,255,0.3)" stroke-width="8" fill="none"/>
                                    <circle cx="40" cy="40" r="36" stroke="#FFFFFF" stroke-width="8" fill="none" 
                                            class="progress-ring" id="progressRing" stroke-dasharray="0 226"/>
                                </svg>
                                <div class="progress-percentage" id="progressPercentage">0%</div>
                            </div>
                            <div class="layout-stack layout-stack--sm">
                                <div><strong id="completedLessons">0</strong> Ù…Ù† <span id="totalLessonsCount">5</span> Ø¯Ø±ÙˆØ³</div>
                                <div class="text-sm">Ø¯Ø±ÙˆØ³ Ù…ÙƒØªÙ…Ù„Ø©</div>
                            </div>
                        </div>
                        <button class="btn btn-primary" id="continueBtn">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ¹Ù„Ù…</button>
                    </div>

                    <!-- Certificate Card -->
                    <div class="card layout-stack certificate-card purple-section is-hidden" id="certificateCard" aria-live="polite">
                        <div class="flex items-center gap-md">
                            <div class="certificate-icon" aria-hidden="true">
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                    <path d="M12 15.5 9.5 17l.5-2.9-2-2 2.9-.4L12 9l1.3 2.7 2.9.4-2 2 .5 2.9z" stroke-linejoin="round"/>
                                    <circle cx="12" cy="12" r="8"/>
                                </svg>
                            </div>
                            <div class="layout-stack layout-stack--xs">
                                <h3 class="heading-md mb-0">Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ø¥ØªÙ…Ø§Ù…</h3>
                                <p class="text-sm text-muted" id="certificateStatus">
                                    Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¯Ø±ÙˆØ³ ÙˆØ§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù„ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø´Ù‡Ø§Ø¯ØªÙƒ Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹Ø© Ù…Ù† Ù…Ù†ØµØ© Ù…Ø³Ø§Ù†Ø¯.
                                </p>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-sm">
                            <button type="button" class="btn btn-primary flex-1" id="certificateBtn">Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</button>
                            <button type="button" class="btn btn-secondary flex-1 is-hidden" id="viewCertificateBtn">Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</button>
                        </div>
                        <dl class="layout-stack layout-stack--xs certificate-meta is-hidden" id="certificateDetails">
                            <div class="certificate-meta__row">
                                <dt>Ø±Ù‚Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</dt>
                                <dd id="certificateIdValue">â€”</dd>
                            </div>
                            <div class="certificate-meta__row">
                                <dt>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±</dt>
                                <dd id="certificateDateValue">â€”</dd>
                            </div>
                            <div class="certificate-meta__row">
                                <dt>Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¹Ù„Ù…</dt>
                                <dd id="certificateNameValue">â€”</dd>
                            </div>
                        </dl>
                    </div>
                </div>
            </div>
        </section>

        <!-- Course Content -->
        <section class="section section--alt">
            <div class="container">
                <div class="grid grid--columns-4 gap-lg">
                    <!-- Lessons Sidebar -->
                    <div class="card layout-stack lessons-sidebar purple-section" id="lessonsSidebar">
                        <div class="flex items-center justify-between">
                            <h3 class="heading-md">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø±ÙˆØ³</h3>
                            <button type="button" class="btn btn-secondary lessons-toggle" id="lessonsToggle" aria-expanded="true" aria-controls="lessonsList">
                                Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                            </button>
                        </div>
                        <div class="lessons-list" id="lessonsList">
                            <!-- Lessons will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="span-3">
                        <!-- Video Section -->
                        <div class="card layout-stack mb-lg purple-section" id="videoSection">
                            <div class="flex justify-between items-center">
                                <h2 class="heading-lg" id="currentLessonTitle">Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„Ø£ÙˆÙ„: Ù…Ù‚Ø¯Ù…Ø© ÙÙŠ Packet Tracer</h2>
                                <div class="lesson-actions">
                                    <button class="btn btn-ghost" id="prevLessonBtn" disabled>
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="m15 18-6-6 6-6"/>
                                        </svg>
                                        Ø§Ù„Ø³Ø§Ø¨Ù‚
                                    </button>
                                    <button class="btn btn-primary" id="nextLessonBtn">
                                        Ø§Ù„ØªØ§Ù„ÙŠ
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="m9 18 6-6-6-6"/>
                                        </svg>
                                    </button>
                                    <button class="btn btn-secondary is-hidden" id="startQuizBtn" type="button">Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
                                </div>
                            </div>
                            
                            <div class="video-container" id="videoContainer">
                                <iframe id="videoPlayer" src="" title="Ù…Ø´ØºÙ„ ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø¯Ø±Ø³" allowfullscreen data-priority="high"></iframe>
                            </div>
                            
                            <div class="lesson-content" id="lessonContent">
                                <!-- Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„Ø¯Ø±Ø³ Ù‡Ù†Ø§ ÙƒÙ‚Ø§Ø¦Ù…Ø© Ù†Ù‚Ø§Ø· Ø¥Ù† ØªÙˆÙØ± -->
                            </div>
                        </div>

                        <!-- Quiz Section -->
                        <div class="card layout-stack purple-section is-hidden" id="quizSection">
                            <h3 class="heading-md">Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹</h3>
                            <p class="text-muted">Ø£Ø¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙÙ‡Ù…Ùƒ Ù„Ù„Ø¯Ø±Ø³:</p>
                            
                            <div id="quizQuestions">
                                <!-- Quiz questions will be populated by JavaScript -->
                            </div>
                            
                            <div class="quiz-actions">
                                <button class="btn btn-primary" id="submitQuizBtn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</button>
                                <button class="btn btn-secondary is-hidden" id="showAnswersBtn">Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</button>
                                <button class="btn btn-ghost is-hidden" id="retryQuizBtn">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
                            </div>
                            
                            <div id="quizResults" class="quiz-results is-hidden" aria-live="polite">
                                <div class="alert quiz-result-alert">
                                    <h4 id="quizResultTitle">Ø§Ù„Ù†ØªÙŠØ¬Ø©</h4>
                                    <p id="quizScore">Ù„Ù‚Ø¯ Ø£Ø¬Ø¨Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©.</p>
                                    <p class="text-sm" id="quizThresholdHint"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div class="certificate-modal" id="certificateModal" role="dialog" aria-modal="true" aria-labelledby="certificateModalTitle">
        <div class="certificate-modal__content layout-stack">
            <div class="flex items-center justify-between gap-md">
                <h3 class="heading-md mb-0" id="certificateModalTitle">Ø¥ØµØ¯Ø§Ø± Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ø¥ØªÙ…Ø§Ù…</h3>
                <button type="button" class="certificate-modal__close" data-dismiss="certificateModal" aria-label="Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                        <path d="M18 6 6 18"/>
                        <path d="m6 6 12 12"/>
                    </svg>
                </button>
            </div>
            <p class="text-sm text-muted">
                Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø°ÙŠ ØªØ±ØºØ¨ ÙÙŠ Ø¸Ù‡ÙˆØ±Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©. ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ÙƒÙ…Ù„Ù PDF Ø£Ùˆ Ù…Ø´Ø§Ø±ÙƒØªÙ‡Ø§ Ù…Ø¹ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†.
            </p>
            <form id="certificateForm" class="layout-stack" novalidate>
                <div>
                    <label for="certificateName" class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</label>
                    <input id="certificateName" name="certificateName" type="text" class="input-field" placeholder="Ù…Ø«Ø§Ù„: Ø³Ø§Ø±Ø© Ø§Ù„Ø¹ÙÙ…Ø±ÙŠ" required>
                </div>
                <label class="checkbox-field">
                    <input type="checkbox" id="certificateShare" name="certificateShare" checked>
                    <span>Ø£Ø±ØºØ¨ ÙÙŠ Ø­ÙØ¸ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ÙÙŠ Ù…Ù„Ù Ø¥Ù†Ø¬Ø§Ø²Ø§ØªÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØµØ©.</span>
                </label>
                <div class="flex justify-end gap-sm">
                    <button type="button" class="btn btn-secondary" data-dismiss="certificateModal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn btn-primary" id="certificateSubmitBtn">Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ø¢Ù†</button>
                </div>
            </form>
        </div>
    </div>

    <footer class="site-footer" data-site-footer data-base="../"></footer>

    <script defer src="../js/config.js"></script>
    <script defer src="../js/components/header.js"></script>
    <script defer src="../js/components/footer.js"></script>
    <script defer src="../js/main.js"></script>
    <script>
        // Optional: Configure global quiz pass percentage here
        window.quizConfig = { passPercentage: 80 };
    </script>
    <script>
        // Get course ID from URL parameters or default to Cisco
        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('course') || 'cisco-packet-tracer';
        
    let currentLessonIndex = 0;
    let course = null;
    let hasAnnouncedCompletion = false;

        // DOM elements
        const courseBadge = document.getElementById('courseBadge');
        const courseTitle = document.getElementById('courseTitle');
        const courseDescription = document.getElementById('courseDescription');
        const courseDuration = document.getElementById('courseDuration');
        const totalLessons = document.getElementById('totalLessons');
        const courseLevel = document.getElementById('courseLevel');
        const progressRing = document.getElementById('progressRing');
        const progressPercentage = document.getElementById('progressPercentage');
        const completedLessonsEl = document.getElementById('completedLessons');
        const totalLessonsCount = document.getElementById('totalLessonsCount');
        const continueBtn = document.getElementById('continueBtn');
        const lessonsList = document.getElementById('lessonsList');
        const currentLessonTitle = document.getElementById('currentLessonTitle');
        const videoPlayer = document.getElementById('videoPlayer');
        const lessonContent = document.getElementById('lessonContent');
        const videoSection = document.getElementById('videoSection');
        const quizSection = document.getElementById('quizSection');
        const quizQuestions = document.getElementById('quizQuestions');
        const submitQuizBtn = document.getElementById('submitQuizBtn');
        const retryQuizBtn = document.getElementById('retryQuizBtn');
        const quizResults = document.getElementById('quizResults');
        const quizScore = document.getElementById('quizScore');
        const showAnswersBtn = document.getElementById('showAnswersBtn');
        const prevLessonBtn = document.getElementById('prevLessonBtn');
    const nextLessonBtn = document.getElementById('nextLessonBtn');
    const startQuizBtn = document.getElementById('startQuizBtn');
        const lessonsSidebar = document.getElementById('lessonsSidebar');
        const lessonsToggle = document.getElementById('lessonsToggle');
        const certificateCard = document.getElementById('certificateCard');
        const certificateStatus = document.getElementById('certificateStatus');
        const certificateBtn = document.getElementById('certificateBtn');
        const viewCertificateBtn = document.getElementById('viewCertificateBtn');
        const certificateDetails = document.getElementById('certificateDetails');
        const certificateIdValue = document.getElementById('certificateIdValue');
        const certificateDateValue = document.getElementById('certificateDateValue');
        const certificateNameValue = document.getElementById('certificateNameValue');
        const certificateModal = document.getElementById('certificateModal');
        const certificateForm = document.getElementById('certificateForm');
        const certificateNameInput = document.getElementById('certificateName');
    const certificateShareInput = document.getElementById('certificateShare');

        // Initialize the course page
        function initializeCourse() {
            course = courseManager.getCourse(courseId);
            
            if (!course) {
                console.error('Course not found');
                return;
            }

            // Populate course information
            courseBadge.textContent = course.badge;
            courseTitle.textContent = course.title;
            courseDescription.textContent = course.description;
            courseDuration.textContent = course.duration.replace(' Ø³Ø§Ø¹Ø§Øª', '').replace(' Ø³Ø§Ø¹Ø©', '');
            totalLessons.textContent = course.lessons.length;
            totalLessonsCount.textContent = course.lessons.length;
            courseLevel.textContent = course.level;

            // Render lessons list
            renderLessonsList();
            
            // Load first lesson
            loadLesson(0);
            
            // Update progress
            updateProgress();

            // Prepare YouTube API for end-of-video detection
            loadYouTubeAPI();
        }

        function renderLessonsList() {
            lessonsList.innerHTML = '';
            
            course.lessons.forEach((lesson, index) => {
                const isCompleted = lesson.completed;
                const isCurrent = index === currentLessonIndex;
                
                const lessonItem = document.createElement('div');
                lessonItem.className = `lesson-item p-md cursor-pointer ${isCompleted ? 'completed' : ''} ${isCurrent ? 'bg-primary-light' : ''}`;
                lessonItem.style.padding = '1rem';
                lessonItem.style.cursor = 'pointer';
                lessonItem.style.borderRadius = 'var(--radius-sm)';
                lessonItem.innerHTML = `
                    <div class="flex items-center gap-sm">
                        <div class="lesson-number" style="font-weight: 600;">
                            ${isCompleted ? 'âœ“' : index + 1}
                        </div>
                        <div class="flex-1">
                            <h4 class="lesson-title" style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.25rem;">${lesson.title}</h4>
                            <div class="lesson-duration" style="font-size: 0.85rem;">${lesson.duration}</div>
                        </div>
                    </div>
                `;
                
                lessonItem.addEventListener('click', () => loadLesson(index));
                lessonsList.appendChild(lessonItem);
            });
        }

        function loadLesson(index) {
            if (index < 0 || index >= course.lessons.length) return;
            
            currentLessonIndex = index;
            const lesson = course.lessons[index];
            
            // Update lesson title and content
            currentLessonTitle.textContent = `Ø§Ù„Ø¯Ø±Ø³ ${index + 1}: ${lesson.title}`;
            // Render summary list if available, else show description
            if (Array.isArray(lesson.summary) && lesson.summary.length) {
                const ul = document.createElement('ul');
                ul.className = 'list-disc pr-lg';
                lesson.summary.forEach(point => {
                    const li = document.createElement('li');
                    li.textContent = point;
                    ul.appendChild(li);
                });
                lessonContent.innerHTML = '';
                const intro = document.createElement('p');
                intro.className = 'mb-sm';
                intro.textContent = lesson.description || '';
                intro.style.color = '#FFFFFF';
                intro.style.fontWeight = '500';
                intro.style.setProperty('color', '#FFFFFF', 'important');
                intro.style.setProperty('font-weight', '500', 'important');
                lessonContent.appendChild(intro);
                lessonContent.appendChild(ul);
            } else {
                lessonContent.textContent = lesson.description || '';
                
                // ØªØ·Ø¨ÙŠÙ‚ Ø£Ù†Ù…Ø§Ø· ÙˆØµÙ Ø§Ù„Ø¯Ø±Ø³
                lessonContent.style.color = '#FFFFFF';
                lessonContent.style.fontWeight = '500';
                lessonContent.style.setProperty('color', '#FFFFFF', 'important');
                lessonContent.style.setProperty('font-weight', '500', 'important');
            }
            
            // Load YouTube video
            if (lesson.videoUrl) {
                const videoId = extractYouTubeVideoId(lesson.videoUrl);
                if (videoId) {
                    // Enable JS API so we can detect video end
                    videoPlayer.src = `https://www.youtube.com/embed/${videoId}?enablejsapi=1&rel=0&modestbranding=1`;
                    videoPlayer.title = lesson.title;
                    // If API is ready, bind/end listener
                    if (window.YT && window.YT.Player) {
                        ensureYouTubePlayer(videoId, lesson.title);
                    }
                }
            }
            
            // Show video section, hide quiz section initially
            videoSection.classList.remove('is-hidden');
            quizSection.classList.add('is-hidden');
            quizQuestions.innerHTML = '';
            quizResults.classList.add('is-hidden');
            submitQuizBtn.classList.remove('is-hidden');
            retryQuizBtn.classList.add('is-hidden');
            showAnswersBtn.classList.add('is-hidden');
            showAnswersBtn.textContent = 'Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª';
            
            // Update navigation buttons
            prevLessonBtn.disabled = index === 0;
            nextLessonBtn.textContent = index === course.lessons.length - 1 ? 'Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ÙƒÙˆØ±Ø³' : 'Ø§Ù„ØªØ§Ù„ÙŠ';

            // Toggle Start Quiz button depending on quiz availability
            const hasQuiz = Array.isArray(lesson.quiz) && lesson.quiz.length > 0;
            startQuizBtn.classList.toggle('is-hidden', !hasQuiz);
            
            // Re-render lessons list to update current lesson highlight
            renderLessonsList();
        }

        function extractYouTubeVideoId(url) {
            const match = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
            return match ? match[1] : null;
        }

        // --- YouTube IFrame API integration ---
        let ytPlayer = null;

        function loadYouTubeAPI() {
            if (window.YT && window.YT.Player) return;
            const tag = document.createElement('script');
            tag.src = 'https://www.youtube.com/iframe_api';
            tag.async = true;
            document.head.appendChild(tag);
        }

        window.onYouTubeIframeAPIReady = function() {
            const lesson = course?.lessons?.[currentLessonIndex];
            const videoId = lesson ? extractYouTubeVideoId(lesson.videoUrl || '') : null;
            if (videoId) {
                ensureYouTubePlayer(videoId, lesson.title);
            }
        };

        function ensureYouTubePlayer(videoId, title) {
            if (!videoId) return;
            try {
                if (ytPlayer && ytPlayer.loadVideoById) {
                    ytPlayer.loadVideoById(videoId);
                    return;
                }
            } catch (_) {}

            ytPlayer = new YT.Player('videoPlayer', {
                videoId,
                playerVars: { rel: 0, modestbranding: 1 },
                events: {
                    onStateChange: (event) => {
                        if (event.data === YT.PlayerState.ENDED) {
                            // Auto-open quiz when video ends
                            const lesson = course.lessons[currentLessonIndex];
                            const hasQuiz = Array.isArray(lesson.quiz) && lesson.quiz.length > 0;
                            if (hasQuiz) {
                                showQuiz();
                            } else {
                                markLessonCompleted();
                            }
                        }
                    },
                    onReady: () => {
                        try { ytPlayer.getIframe().setAttribute('title', title || 'Ù…Ø´ØºÙ„ ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø¯Ø±Ø³'); } catch (_) {}
                    }
                }
            });
        }

        function showQuiz() {
            // Generate quiz for current lesson
            const lesson = course.lessons[currentLessonIndex];
            const quiz = courseManager.generateQuiz(courseId, lesson.id);
            
            if (!quiz || quiz.length === 0) {
                // No quiz for this lesson, mark as completed and move to next
                markLessonCompleted();
                if (currentLessonIndex < course.lessons.length - 1) {
                    loadLesson(currentLessonIndex + 1);
                } else {
                    alert('ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø§Ù„ÙƒÙˆØ±Ø³ Ø¨Ù†Ø¬Ø§Ø­');
                }
                return;
            }
            
            videoSection.classList.add('is-hidden');
            quizSection.classList.remove('is-hidden');
            
            // Generate quiz HTML
            quizQuestions.innerHTML = '';
            quiz.forEach((question, qIndex) => {
                const questionEl = document.createElement('div');
                questionEl.className = 'quiz-question';
                questionEl.innerHTML = `
                    <h4 class="mb-md">${qIndex + 1}. ${question.question}</h4>
                    <div class="quiz-options">
                        ${question.options.map((option, oIndex) => `
                            <label class="quiz-option block cursor-pointer" data-question="${qIndex}" data-option="${oIndex}">
                                <input type="radio" name="question-${qIndex}" value="${oIndex}" class="sr-only">
                                <span>${option}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div class="quiz-explanation is-hidden text-sm text-muted mt-sm" data-explain-for="${qIndex}"></div>
                `;
                quizQuestions.appendChild(questionEl);
            });
            
            // Add click handlers for quiz options
            document.querySelectorAll('.quiz-option').forEach(option => {
                option.addEventListener('click', function() {
                    const questionIndex = this.dataset.question;
                    const radio = this.querySelector('input[type="radio"]');
                    radio.checked = true;
                    
                    // Remove selected class from siblings
                    this.parentElement.querySelectorAll('.quiz-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked option
                    this.classList.add('selected');
                });
            });

            // Reset actions state
            submitQuizBtn.classList.remove('is-hidden');
            retryQuizBtn.classList.add('is-hidden');
            showAnswersBtn.classList.add('is-hidden');
            showAnswersBtn.textContent = 'Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª';
            quizResults.classList.add('is-hidden');
        }

        function submitQuiz() {
            const answers = {};
            const lesson = course.lessons[currentLessonIndex];
            const quiz = courseManager.generateQuiz(courseId, lesson.id);
            
            quiz.forEach((question, qIndex) => {
                const selectedOption = document.querySelector(`input[name="question-${qIndex}"]:checked`);
                if (selectedOption) {
                    answers[qIndex] = parseInt(selectedOption.value);
                }
            });
            
            const result = courseManager.checkQuizAnswers(courseId, lesson.id, answers);
            
            // Show visual feedback for each answer
            quiz.forEach((question, qIndex) => {
                const options = document.querySelectorAll(`[data-question="${qIndex}"]`);
                
                options.forEach((option, oIndex) => {
                    option.classList.remove('correct', 'incorrect', 'selected');
                    
                    if (oIndex === question.correct) {
                        option.classList.add('correct');
                    } else if (answers[qIndex] === oIndex) {
                        option.classList.add('incorrect');
                    }
                });
                // Fill explanations but keep hidden until requested
                const exp = document.querySelector(`.quiz-explanation[data-explain-for="${qIndex}"]`);
                if (exp) {
                    const detail = result.details[qIndex];
                    exp.textContent = detail && detail.explanation ? `Ø§Ù„Ø´Ø±Ø­: ${detail.explanation}` : '';
                }
            });
            
            // Show results
            quizScore.textContent = `Ù„Ù‚Ø¯ Ø£Ø¬Ø¨Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ø¹Ù„Ù‰ ${result.score} Ù…Ù† ${result.total} Ø£Ø³Ø¦Ù„Ø© (${result.percentage}%)`;
            const hint = document.getElementById('quizThresholdHint');
            if (hint && typeof result.threshold === 'number') {
                hint.textContent = `Ø§Ù„Ù†Ø¬Ø§Ø­ ÙŠØªØ·Ù„Ø¨ ${result.threshold}% ÙØ£ÙƒØ«Ø±`;
            }
            const titleEl = document.getElementById('quizResultTitle');
            if (result.passed) {
                quizResults.firstElementChild.className = 'alert alert--success';
                if (titleEl) titleEl.textContent = 'Ù…Ù…ØªØ§Ø²!';
                showAnswersBtn.classList.remove('is-hidden');
                markLessonCompleted();
            } else {
                quizResults.firstElementChild.className = 'alert alert--warning';
                if (titleEl) titleEl.textContent = 'ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù†ØªÙŠØ¬Ø©';
                retryQuizBtn.classList.remove('is-hidden');
                showAnswersBtn.classList.remove('is-hidden');
            }
            quizResults.classList.remove('is-hidden');
            submitQuizBtn.classList.add('is-hidden');
        }

        function markLessonCompleted() {
            const lesson = course.lessons[currentLessonIndex];
            courseManager.markLessonCompleted(courseId, lesson.id);
            updateProgress();
            renderLessonsList();
        }

        function updateProgress() {
            const progress = courseManager.getProgressPercentage(courseId);
            const completed = course.lessons.filter(l => l.completed).length;
            const total = course.lessons.length;
            
            // Update progress ring
            const circumference = 2 * Math.PI * 36; // radius = 36
            const offset = circumference - (progress / 100) * circumference;
            progressRing.style.strokeDasharray = `${circumference - offset} ${offset}`;
            
            // Update text
            progressPercentage.textContent = `${progress}%`;
            completedLessonsEl.textContent = completed;

            updateCertificateUI(progress, completed, total);
        }

        function updateCertificateUI(progress, completed, total) {
            if (!certificateCard || typeof certificateManager === 'undefined') {
                return;
            }

            if (progress >= 100) {
                certificateCard.classList.remove('is-hidden');
                const existingCertificate = certificateManager.getCertificate(courseId);

                if (existingCertificate) {
                    certificateStatus.textContent = `ØªÙ… Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¨ØªØ§Ø±ÙŠØ® ${formatCertificateDate(existingCertificate.issuedAt)}.`;
                    certificateBtn.classList.add('is-hidden');
                    viewCertificateBtn.classList.remove('is-hidden');
                    certificateDetails.classList.remove('is-hidden');
                    certificateIdValue.textContent = existingCertificate.certificateId || 'â€”';
                    certificateDateValue.textContent = formatCertificateDate(existingCertificate.issuedAt);
                    certificateNameValue.textContent = existingCertificate.userName || 'â€”';
                } else {
                    certificateStatus.textContent = 'ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ø£ÙƒÙ…Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±ÙˆØ³ ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø¥ØµØ¯Ø§Ø± Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ Ø§Ù„Ø¢Ù†.';
                    certificateBtn.classList.remove('is-hidden');
                    viewCertificateBtn.classList.add('is-hidden');
                    certificateDetails.classList.add('is-hidden');
                    certificateIdValue.textContent = 'â€”';
                    certificateDateValue.textContent = 'â€”';
                    certificateNameValue.textContent = 'â€”';

                    if (!hasAnnouncedCompletion) {
                        if (typeof showMessage === 'function') {
                            showMessage('ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ø£ØµØ¨Ø­Øª Ù…Ø¤Ù‡Ù„Ø§Ù‹ Ù„Ø¥ØµØ¯Ø§Ø± Ø´Ù‡Ø§Ø¯Ø© Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¯ÙˆØ±Ø©.', 'success');
                        }
                        hasAnnouncedCompletion = true;
                    }
                }
            } else {
                certificateCard.classList.add('is-hidden');
            }
        }

        function formatCertificateDate(value) {
            if (!value) {
                return 'â€”';
            }
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) {
                return 'â€”';
            }
            return date.toLocaleDateString('ar-SA', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }

        function retryQuiz() {
            // Reset quiz state
            document.querySelectorAll('.quiz-option').forEach(option => {
                option.classList.remove('correct', 'incorrect', 'selected');
                option.querySelector('input').checked = false;
            });
            
            quizResults.classList.add('is-hidden');
            submitQuizBtn.classList.remove('is-hidden');
            retryQuizBtn.classList.add('is-hidden');
            showAnswersBtn.classList.add('is-hidden');
            document.querySelectorAll('.quiz-explanation').forEach(el => el.classList.add('is-hidden'));
            showAnswersBtn.textContent = 'Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª';
        }

        function showAnswers() {
            // Toggle explanations visibility and button text
            const anyHidden = Array.from(document.querySelectorAll('.quiz-explanation'))
                .some(el => !el.textContent || el.classList.contains('is-hidden'));
            document.querySelectorAll('.quiz-explanation').forEach(el => {
                if (!el.textContent || el.textContent.trim().length === 0) return;
                if (anyHidden) {
                    el.classList.remove('is-hidden');
                } else {
                    el.classList.add('is-hidden');
                }
            });
            if (anyHidden) {
                showAnswersBtn.textContent = 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª';
            } else {
                showAnswersBtn.textContent = 'Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª';
            }
        }

        function openCertificateModal() {
            if (!certificateModal) {
                return;
            }

            prefillCertificateForm();
            certificateModal.classList.add('is-open');
            document.body.classList.add('has-modal-open');

            window.requestAnimationFrame(() => {
                certificateNameInput?.focus();
            });
        }

        function closeCertificateModal() {
            if (!certificateModal) {
                return;
            }

            certificateModal.classList.remove('is-open');
            document.body.classList.remove('has-modal-open');
        }

        function prefillCertificateForm() {
            if (!certificateNameInput || typeof certificateManager === 'undefined') {
                return;
            }

            const profile = certificateManager.getProfile();
            if (profile?.fullName) {
                certificateNameInput.value = profile.fullName;
            }
            if (certificateShareInput && typeof profile?.shareCertificates === 'boolean') {
                certificateShareInput.checked = profile.shareCertificates;
            }
        }

        function openCertificatePage(certificateData) {
            const params = new URLSearchParams({ course: courseId });
            if (certificateData?.certificateId) {
                params.set('certificateId', certificateData.certificateId);
            }
            window.open(`certificate.html?${params.toString()}`, '_blank', 'noopener');
        }

        function handleCertificateFormSubmit(event) {
            event.preventDefault();

            if (!certificateForm || typeof certificateManager === 'undefined') {
                return;
            }

            const fullName = certificateNameInput?.value.trim();
            if (!fullName) {
                certificateNameInput?.focus();
                return;
            }

            const completed = course.lessons.filter(l => l.completed).length;
            const shareRequested = certificateShareInput?.checked || false;
            const certificate = certificateManager.issueCertificate(courseId, {
                courseTitle: course.title,
                courseBadge: course.badge,
                userName: fullName,
                totalLessons: course.lessons.length,
                lessonsCompleted: completed,
                metadata: { shareRequested }
            });

            const existingProfile = certificateManager.getProfile() || {};

            certificateManager.updateProfile({
                fullName,
                preferredTrack: course.category,
                email: existingProfile.email || undefined,
                shareCertificates: shareRequested
            });

            closeCertificateModal();
            updateCertificateUI(100, completed, course.lessons.length);

            if (typeof showMessage === 'function') {
                showMessage('ØªÙ… Ø¥ØµØ¯Ø§Ø± Ø´Ù‡Ø§Ø¯ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ†Ø²ÙŠÙ„Ù‡Ø§ Ø£Ùˆ Ù…Ø´Ø§Ø±ÙƒØªÙ‡Ø§.', 'success');
            }

            openCertificatePage(certificate);
        }

        // Event listeners
        continueBtn.addEventListener('click', () => {
            // Find first incomplete lesson or current lesson
            const nextIncomplete = course.lessons.findIndex(lesson => !lesson.completed);
            loadLesson(nextIncomplete >= 0 ? nextIncomplete : 0);
        });

        prevLessonBtn.addEventListener('click', () => {
            if (currentLessonIndex > 0) {
                loadLesson(currentLessonIndex - 1);
            }
        });

        nextLessonBtn.addEventListener('click', () => {
            const lesson = course.lessons[currentLessonIndex];

            if (!lesson.completed) {
                showQuiz();
                return;
            }

            if (currentLessonIndex < course.lessons.length - 1) {
                loadLesson(currentLessonIndex + 1);
                return;
            }

            updateProgress();

            if (typeof certificateManager !== 'undefined' && certificateManager.hasCertificate(courseId)) {
                openCertificatePage(certificateManager.getCertificate(courseId));
            } else if (certificateCard) {
                certificateCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });

    submitQuizBtn.addEventListener('click', submitQuiz);
        retryQuizBtn.addEventListener('click', retryQuiz);
    showAnswersBtn.addEventListener('click', showAnswers);
        startQuizBtn.addEventListener('click', showQuiz);

        certificateBtn?.addEventListener('click', openCertificateModal);
        viewCertificateBtn?.addEventListener('click', () => {
            if (typeof certificateManager === 'undefined') {
                return;
            }
            const certificate = certificateManager.getCertificate(courseId);
            if (certificate) {
                openCertificatePage(certificate);
            } else {
                openCertificateModal();
            }
        });

        certificateForm?.addEventListener('submit', handleCertificateFormSubmit);

        document.querySelectorAll('[data-dismiss="certificateModal"]').forEach(element => {
            element.addEventListener('click', closeCertificateModal);
        });

        certificateModal?.addEventListener('click', event => {
            if (event.target === certificateModal) {
                closeCertificateModal();
            }
        });

        document.addEventListener('keydown', event => {
            if (event.key === 'Escape' && certificateModal?.classList.contains('is-open')) {
                closeCertificateModal();
            }
        });

        // Toggle lessons sidebar (mobile)
        lessonsToggle.addEventListener('click', () => {
            const collapsed = lessonsSidebar.classList.toggle('is-collapsed');
            lessonsToggle.setAttribute('aria-expanded', String(!collapsed));
            lessonsToggle.textContent = collapsed ? 'Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©' : 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©';
        });

        // Initialize the course when page loads
        document.addEventListener('DOMContentLoaded', initializeCourse);
    </script>
</body>
</html>