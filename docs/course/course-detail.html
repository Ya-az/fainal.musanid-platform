<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎓 تفاصيل الكورس - منصة مساند التعليمية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'musanid-dark': '#6D28D9',
                        'musanid-light': '#A78BFA',
                    }
                }
            }
        }
    </script>
    <link href="../css/styles.css" rel="stylesheet">
    <script defer src="../js/course-manager.js"></script>
    <script defer src="../js/certificate-manager.js"></script>
    <style>
        .progress-ring {
            transform: rotate(-90deg);
            transition: stroke-dasharray 0.35s;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
        }
        
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            border-radius: var(--radius-md);
        }
        
        .quiz-question {
            background: var(--color-neutral-50);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .quiz-option {
            padding: 0.75rem 1rem;
            border: 2px solid var(--color-neutral-200);
            border-radius: var(--radius-sm);
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .quiz-option:hover {
            border-color: var(--color-primary);
            background: rgba(var(--color-primary-rgb), 0.05);
        }
        
        .quiz-option.selected {
            border-color: var(--color-primary);
            background: rgba(var(--color-primary-rgb), 0.1);
        }
        
        .quiz-option.correct {
            border-color: var(--color-success);
            background: rgba(22, 163, 74, 0.1);
        }
        
        .quiz-option.incorrect {
            border-color: var(--color-error);
            background: rgba(220, 38, 38, 0.1);
        }

        .certificate-icon {
            width: 3.25rem;
            height: 3.25rem;
            border-radius: var(--radius-full);
            background: rgba(255, 255, 255, 0.2);
            display: grid;
            place-items: center;
            color: #FFFFFF;
            flex-shrink: 0;
        }

        .certificate-meta {
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            margin-top: var(--spacing-sm);
            padding-top: var(--spacing-sm);
            gap: 0.5rem;
        }

        .certificate-meta__row {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            font-size: 0.875rem;
        }

        .certificate-meta__row dd {
            font-weight: 600;
        }

        .certificate-modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            background: rgba(15, 23, 42, 0.6);
            z-index: 1000;
        }

        .certificate-modal.is-open {
            display: flex;
        }

        .certificate-modal__content {
            background: var(--color-neutral-0, #ffffff);
            border-radius: var(--radius-lg);
            box-shadow: 0 25px 50px -12px rgba(15, 23, 42, 0.25);
            max-width: 480px;
            width: 100%;
            padding: 2rem;
        }

        .certificate-modal__close {
            background: none;
            border: none;
            cursor: pointer;
            color: inherit;
        }

        body.has-modal-open {
            overflow: hidden;
        }
    </style>
</head>
<body>
    <header class="site-header" data-site-header data-base="../" data-active="courses" data-nav-id="courseDetailNav" data-home="index.html" data-primary-href="../auth/login.html"></header>

    <main>
        <!-- Course Header -->
        <section class="section">
            <div class="container">
                <div class="grid grid--columns-3 gap-lg">
                    <!-- Course Info -->
                    <div class="span-2">
                        <div class="layout-stack">
                            <div class="flex items-center gap-sm mb-md">
                                <a href="cr_index.html" class="btn btn-ghost">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="m15 18-6-6 6-6"/>
                                    </svg>
                                    العودة للدورات
                                </a>
                                <span class="badge" id="courseBadge">شبكات</span>
                            </div>
                            <h1 class="heading-xl" id="courseTitle">أساسيات Cisco Packet Tracer</h1>
                            <p class="text-lg text-muted" id="courseDescription">
                                ابدأ ببناء شبكات افتراضية باستخدام Packet Tracer وتعلم ضبط الأجهزة خطوة بخطوة مع سيناريوهات عملية.
                            </p>
                            <div class="flex gap-md">
                                <div class="stat-mini">
                                    <span class="stat-mini__value" id="courseDuration">5</span>
                                    <span class="stat-mini__label">أسابيع</span>
                                </div>
                                <div class="stat-mini">
                                    <span class="stat-mini__value" id="totalLessons">5</span>
                                    <span class="stat-mini__label">دروس</span>
                                </div>
                                <div class="stat-mini">
                                    <span class="stat-mini__value" id="courseLevel">مبتدئ</span>
                                    <span class="stat-mini__label">المستوى</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Progress Card -->
                    <div class="card layout-stack purple-section">
                        <h3 class="heading-md">التقدم في الكورس</h3>
                        <div class="flex items-center gap-md">
                            <div class="progress-circle">
                                <svg width="80" height="80" viewBox="0 0 80 80">
                                    <circle cx="40" cy="40" r="36" stroke="rgba(255,255,255,0.3)" stroke-width="8" fill="none"/>
                                    <circle cx="40" cy="40" r="36" stroke="#FFFFFF" stroke-width="8" fill="none" 
                                            class="progress-ring" id="progressRing" stroke-dasharray="0 226"/>
                                </svg>
                                <div class="progress-percentage" id="progressPercentage">0%</div>
                            </div>
                            <div class="layout-stack layout-stack--sm">
                                <div><strong id="completedLessons">0</strong> من <span id="totalLessonsCount">5</span> دروس</div>
                                <div class="text-sm">دروس مكتملة</div>
                            </div>
                        </div>
                        <button class="btn btn-primary" id="continueBtn">متابعة التعلم</button>
                    </div>

                    <!-- Certificate Card -->
                    <div class="card layout-stack certificate-card purple-section is-hidden" id="certificateCard" aria-live="polite">
                        <div class="flex items-center gap-md">
                            <div class="certificate-icon" aria-hidden="true">
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                    <path d="M12 15.5 9.5 17l.5-2.9-2-2 2.9-.4L12 9l1.3 2.7 2.9.4-2 2 .5 2.9z" stroke-linejoin="round"/>
                                    <circle cx="12" cy="12" r="8"/>
                                </svg>
                            </div>
                            <div class="layout-stack layout-stack--xs">
                                <h3 class="heading-md mb-0">شهادة الإتمام</h3>
                                <p class="text-sm text-muted" id="certificateStatus">
                                    أكمل الدروس والاختبارات لتحصل على شهادتك الرقمية الموقعة من منصة مساند.
                                </p>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-sm">
                            <button type="button" class="btn btn-primary flex-1" id="certificateBtn">إصدار الشهادة</button>
                            <button type="button" class="btn btn-secondary flex-1 is-hidden" id="viewCertificateBtn">عرض الشهادة</button>
                        </div>
                        <dl class="layout-stack layout-stack--xs certificate-meta is-hidden" id="certificateDetails">
                            <div class="certificate-meta__row">
                                <dt>رقم الشهادة</dt>
                                <dd id="certificateIdValue">—</dd>
                            </div>
                            <div class="certificate-meta__row">
                                <dt>تاريخ الإصدار</dt>
                                <dd id="certificateDateValue">—</dd>
                            </div>
                            <div class="certificate-meta__row">
                                <dt>اسم المتعلم</dt>
                                <dd id="certificateNameValue">—</dd>
                            </div>
                        </dl>
                    </div>
                </div>
            </div>
        </section>

        <!-- Course Content -->
        <section class="section section--alt">
            <div class="container">
                <div class="grid grid--columns-4 gap-lg">
                    <!-- Lessons Sidebar -->
                    <div class="card layout-stack lessons-sidebar purple-section" id="lessonsSidebar">
                        <div class="flex items-center justify-between">
                            <h3 class="heading-md">قائمة الدروس</h3>
                            <button type="button" class="btn btn-secondary lessons-toggle" id="lessonsToggle" aria-expanded="true" aria-controls="lessonsList">
                                إخفاء القائمة
                            </button>
                        </div>
                        <div class="lessons-list" id="lessonsList">
                            <!-- Lessons will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="span-3">
                        <!-- Video Section -->
                        <div class="card layout-stack mb-lg purple-section" id="videoSection">
                            <div class="flex justify-between items-center">
                                <h2 class="heading-lg" id="currentLessonTitle">الدرس الأول: مقدمة في Packet Tracer</h2>
                                <div class="lesson-actions">
                                    <button class="btn btn-ghost" id="prevLessonBtn" disabled>
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="m15 18-6-6 6-6"/>
                                        </svg>
                                        السابق
                                    </button>
                                    <button class="btn btn-primary" id="nextLessonBtn">
                                        التالي
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="m9 18 6-6-6-6"/>
                                        </svg>
                                    </button>
                                    <button class="btn btn-secondary is-hidden" id="startQuizBtn" type="button">بدء الاختبار</button>
                                </div>
                            </div>
                            
                            <div class="video-container" id="videoContainer">
                                <iframe id="videoPlayer" src="" title="مشغل فيديو الدرس" allowfullscreen data-priority="high"></iframe>
                            </div>
                            
                            <div class="lesson-content" id="lessonContent">
                                <!-- سيتم عرض ملخص الدرس هنا كقائمة نقاط إن توفر -->
                            </div>
                        </div>

                        <!-- Quiz Section -->
                        <div class="card layout-stack purple-section is-hidden" id="quizSection">
                            <h3 class="heading-md">اختبار سريع</h3>
                            <p class="text-muted">أجب على الأسئلة التالية للتأكد من فهمك للدرس:</p>
                            
                            <div id="quizQuestions">
                                <!-- Quiz questions will be populated by JavaScript -->
                            </div>
                            
                            <div class="quiz-actions">
                                <button class="btn btn-primary" id="submitQuizBtn">إرسال الإجابات</button>
                                <button class="btn btn-secondary is-hidden" id="showAnswersBtn">عرض الإجابات</button>
                                <button class="btn btn-ghost is-hidden" id="retryQuizBtn">إعادة المحاولة</button>
                            </div>
                            
                            <div id="quizResults" class="quiz-results is-hidden" aria-live="polite">
                                <div class="alert quiz-result-alert">
                                    <h4 id="quizResultTitle">النتيجة</h4>
                                    <p id="quizScore">لقد أجبت بشكل صحيح على جميع الأسئلة.</p>
                                    <p class="text-sm" id="quizThresholdHint"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div class="certificate-modal" id="certificateModal" role="dialog" aria-modal="true" aria-labelledby="certificateModalTitle">
        <div class="certificate-modal__content layout-stack">
            <div class="flex items-center justify-between gap-md">
                <h3 class="heading-md mb-0" id="certificateModalTitle">إصدار شهادة الإتمام</h3>
                <button type="button" class="certificate-modal__close" data-dismiss="certificateModal" aria-label="إغلاق النافذة">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                        <path d="M18 6 6 18"/>
                        <path d="m6 6 12 12"/>
                    </svg>
                </button>
            </div>
            <p class="text-sm text-muted">
                أدخل الاسم الذي ترغب في ظهوره على الشهادة. يمكنك تنزيل الشهادة كملف PDF أو مشاركتها مع الآخرين.
            </p>
            <form id="certificateForm" class="layout-stack" novalidate>
                <div>
                    <label for="certificateName" class="form-label">الاسم الكامل على الشهادة</label>
                    <input id="certificateName" name="certificateName" type="text" class="input-field" placeholder="مثال: سارة العُمري" required>
                </div>
                <label class="checkbox-field">
                    <input type="checkbox" id="certificateShare" name="certificateShare" checked>
                    <span>أرغب في حفظ هذه الشهادة في ملف إنجازاتي على المنصة.</span>
                </label>
                <div class="flex justify-end gap-sm">
                    <button type="button" class="btn btn-secondary" data-dismiss="certificateModal">إلغاء</button>
                    <button type="submit" class="btn btn-primary" id="certificateSubmitBtn">إصدار الشهادة الآن</button>
                </div>
            </form>
        </div>
    </div>

    <footer class="site-footer" data-site-footer data-base="../"></footer>

    <script defer src="../js/config.js"></script>
    <script defer src="../js/components/header.js"></script>
    <script defer src="../js/components/footer.js"></script>
    <script defer src="../js/main.js"></script>
    <script>
        // Optional: Configure global quiz pass percentage here
        window.quizConfig = { passPercentage: 80 };
    </script>
    <script>
        // Get course ID from URL parameters or default to Cisco
        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('course') || 'cisco-packet-tracer';
        
    let currentLessonIndex = 0;
    let course = null;
    let hasAnnouncedCompletion = false;

        // DOM elements
        const courseBadge = document.getElementById('courseBadge');
        const courseTitle = document.getElementById('courseTitle');
        const courseDescription = document.getElementById('courseDescription');
        const courseDuration = document.getElementById('courseDuration');
        const totalLessons = document.getElementById('totalLessons');
        const courseLevel = document.getElementById('courseLevel');
        const progressRing = document.getElementById('progressRing');
        const progressPercentage = document.getElementById('progressPercentage');
        const completedLessonsEl = document.getElementById('completedLessons');
        const totalLessonsCount = document.getElementById('totalLessonsCount');
        const continueBtn = document.getElementById('continueBtn');
        const lessonsList = document.getElementById('lessonsList');
        const currentLessonTitle = document.getElementById('currentLessonTitle');
        const videoPlayer = document.getElementById('videoPlayer');
        const lessonContent = document.getElementById('lessonContent');
        const videoSection = document.getElementById('videoSection');
        const quizSection = document.getElementById('quizSection');
        const quizQuestions = document.getElementById('quizQuestions');
        const submitQuizBtn = document.getElementById('submitQuizBtn');
        const retryQuizBtn = document.getElementById('retryQuizBtn');
        const quizResults = document.getElementById('quizResults');
        const quizScore = document.getElementById('quizScore');
        const showAnswersBtn = document.getElementById('showAnswersBtn');
        const prevLessonBtn = document.getElementById('prevLessonBtn');
    const nextLessonBtn = document.getElementById('nextLessonBtn');
    const startQuizBtn = document.getElementById('startQuizBtn');
        const lessonsSidebar = document.getElementById('lessonsSidebar');
        const lessonsToggle = document.getElementById('lessonsToggle');
        const certificateCard = document.getElementById('certificateCard');
        const certificateStatus = document.getElementById('certificateStatus');
        const certificateBtn = document.getElementById('certificateBtn');
        const viewCertificateBtn = document.getElementById('viewCertificateBtn');
        const certificateDetails = document.getElementById('certificateDetails');
        const certificateIdValue = document.getElementById('certificateIdValue');
        const certificateDateValue = document.getElementById('certificateDateValue');
        const certificateNameValue = document.getElementById('certificateNameValue');
        const certificateModal = document.getElementById('certificateModal');
        const certificateForm = document.getElementById('certificateForm');
        const certificateNameInput = document.getElementById('certificateName');
    const certificateShareInput = document.getElementById('certificateShare');

        // Initialize the course page
        function initializeCourse() {
            course = courseManager.getCourse(courseId);
            
            if (!course) {
                console.error('Course not found');
                return;
            }

            // Populate course information
            courseBadge.textContent = course.badge;
            courseTitle.textContent = course.title;
            courseDescription.textContent = course.description;
            courseDuration.textContent = course.duration.replace(' ساعات', '').replace(' ساعة', '');
            totalLessons.textContent = course.lessons.length;
            totalLessonsCount.textContent = course.lessons.length;
            courseLevel.textContent = course.level;

            // Render lessons list
            renderLessonsList();
            
            // Load first lesson
            loadLesson(0);
            
            // Update progress
            updateProgress();

            // Prepare YouTube API for end-of-video detection
            loadYouTubeAPI();
        }

        function renderLessonsList() {
            lessonsList.innerHTML = '';
            
            course.lessons.forEach((lesson, index) => {
                const isCompleted = lesson.completed;
                const isCurrent = index === currentLessonIndex;
                
                const lessonItem = document.createElement('div');
                lessonItem.className = `lesson-item p-md cursor-pointer ${isCompleted ? 'completed' : ''} ${isCurrent ? 'bg-primary-light' : ''}`;
                lessonItem.style.padding = '1rem';
                lessonItem.style.cursor = 'pointer';
                lessonItem.style.borderRadius = 'var(--radius-sm)';
                lessonItem.innerHTML = `
                    <div class="flex items-center gap-sm">
                        <div class="lesson-number" style="font-weight: 600;">
                            ${isCompleted ? '✓' : index + 1}
                        </div>
                        <div class="flex-1">
                            <h4 class="lesson-title" style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.25rem;">${lesson.title}</h4>
                            <div class="lesson-duration" style="font-size: 0.85rem;">${lesson.duration}</div>
                        </div>
                    </div>
                `;
                
                lessonItem.addEventListener('click', () => loadLesson(index));
                lessonsList.appendChild(lessonItem);
            });
        }

        function loadLesson(index) {
            if (index < 0 || index >= course.lessons.length) return;
            
            currentLessonIndex = index;
            const lesson = course.lessons[index];
            
            // Update lesson title and content
            currentLessonTitle.textContent = `الدرس ${index + 1}: ${lesson.title}`;
            // Render summary list if available, else show description
            if (Array.isArray(lesson.summary) && lesson.summary.length) {
                const ul = document.createElement('ul');
                ul.className = 'list-disc pr-lg';
                lesson.summary.forEach(point => {
                    const li = document.createElement('li');
                    li.textContent = point;
                    ul.appendChild(li);
                });
                lessonContent.innerHTML = '';
                const intro = document.createElement('p');
                intro.className = 'mb-sm';
                intro.textContent = lesson.description || '';
                intro.style.color = '#FFFFFF';
                intro.style.fontWeight = '500';
                intro.style.setProperty('color', '#FFFFFF', 'important');
                intro.style.setProperty('font-weight', '500', 'important');
                lessonContent.appendChild(intro);
                lessonContent.appendChild(ul);
            } else {
                lessonContent.textContent = lesson.description || '';
                
                // تطبيق أنماط وصف الدرس
                lessonContent.style.color = '#FFFFFF';
                lessonContent.style.fontWeight = '500';
                lessonContent.style.setProperty('color', '#FFFFFF', 'important');
                lessonContent.style.setProperty('font-weight', '500', 'important');
            }
            
            // Load YouTube video
            if (lesson.videoUrl) {
                const videoId = extractYouTubeVideoId(lesson.videoUrl);
                if (videoId) {
                    // Enable JS API so we can detect video end
                    videoPlayer.src = `https://www.youtube.com/embed/${videoId}?enablejsapi=1&rel=0&modestbranding=1`;
                    videoPlayer.title = lesson.title;
                    // If API is ready, bind/end listener
                    if (window.YT && window.YT.Player) {
                        ensureYouTubePlayer(videoId, lesson.title);
                    }
                }
            }
            
            // Show video section, hide quiz section initially
            videoSection.classList.remove('is-hidden');
            quizSection.classList.add('is-hidden');
            quizQuestions.innerHTML = '';
            quizResults.classList.add('is-hidden');
            submitQuizBtn.classList.remove('is-hidden');
            retryQuizBtn.classList.add('is-hidden');
            showAnswersBtn.classList.add('is-hidden');
            showAnswersBtn.textContent = 'عرض الإجابات';
            
            // Update navigation buttons
            prevLessonBtn.disabled = index === 0;
            nextLessonBtn.textContent = index === course.lessons.length - 1 ? 'إنهاء الكورس' : 'التالي';

            // Toggle Start Quiz button depending on quiz availability
            const hasQuiz = Array.isArray(lesson.quiz) && lesson.quiz.length > 0;
            startQuizBtn.classList.toggle('is-hidden', !hasQuiz);
            
            // Re-render lessons list to update current lesson highlight
            renderLessonsList();
        }

        function extractYouTubeVideoId(url) {
            const match = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
            return match ? match[1] : null;
        }

        // --- YouTube IFrame API integration ---
        let ytPlayer = null;

        function loadYouTubeAPI() {
            if (window.YT && window.YT.Player) return;
            const tag = document.createElement('script');
            tag.src = 'https://www.youtube.com/iframe_api';
            tag.async = true;
            document.head.appendChild(tag);
        }

        window.onYouTubeIframeAPIReady = function() {
            const lesson = course?.lessons?.[currentLessonIndex];
            const videoId = lesson ? extractYouTubeVideoId(lesson.videoUrl || '') : null;
            if (videoId) {
                ensureYouTubePlayer(videoId, lesson.title);
            }
        };

        function ensureYouTubePlayer(videoId, title) {
            if (!videoId) return;
            try {
                if (ytPlayer && ytPlayer.loadVideoById) {
                    ytPlayer.loadVideoById(videoId);
                    return;
                }
            } catch (_) {}

            ytPlayer = new YT.Player('videoPlayer', {
                videoId,
                playerVars: { rel: 0, modestbranding: 1 },
                events: {
                    onStateChange: (event) => {
                        if (event.data === YT.PlayerState.ENDED) {
                            // Auto-open quiz when video ends
                            const lesson = course.lessons[currentLessonIndex];
                            const hasQuiz = Array.isArray(lesson.quiz) && lesson.quiz.length > 0;
                            if (hasQuiz) {
                                showQuiz();
                            } else {
                                markLessonCompleted();
                            }
                        }
                    },
                    onReady: () => {
                        try { ytPlayer.getIframe().setAttribute('title', title || 'مشغل فيديو الدرس'); } catch (_) {}
                    }
                }
            });
        }

        function showQuiz() {
            // Generate quiz for current lesson
            const lesson = course.lessons[currentLessonIndex];
            const quiz = courseManager.generateQuiz(courseId, lesson.id);
            
            if (!quiz || quiz.length === 0) {
                // No quiz for this lesson, mark as completed and move to next
                markLessonCompleted();
                if (currentLessonIndex < course.lessons.length - 1) {
                    loadLesson(currentLessonIndex + 1);
                } else {
                    alert('تهانينا! لقد أكملت الكورس بنجاح');
                }
                return;
            }
            
            videoSection.classList.add('is-hidden');
            quizSection.classList.remove('is-hidden');
            
            // Generate quiz HTML
            quizQuestions.innerHTML = '';
            quiz.forEach((question, qIndex) => {
                const questionEl = document.createElement('div');
                questionEl.className = 'quiz-question';
                questionEl.innerHTML = `
                    <h4 class="mb-md">${qIndex + 1}. ${question.question}</h4>
                    <div class="quiz-options">
                        ${question.options.map((option, oIndex) => `
                            <label class="quiz-option block cursor-pointer" data-question="${qIndex}" data-option="${oIndex}">
                                <input type="radio" name="question-${qIndex}" value="${oIndex}" class="sr-only">
                                <span>${option}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div class="quiz-explanation is-hidden text-sm text-muted mt-sm" data-explain-for="${qIndex}"></div>
                `;
                quizQuestions.appendChild(questionEl);
            });
            
            // Add click handlers for quiz options
            document.querySelectorAll('.quiz-option').forEach(option => {
                option.addEventListener('click', function() {
                    const questionIndex = this.dataset.question;
                    const radio = this.querySelector('input[type="radio"]');
                    radio.checked = true;
                    
                    // Remove selected class from siblings
                    this.parentElement.querySelectorAll('.quiz-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked option
                    this.classList.add('selected');
                });
            });

            // Reset actions state
            submitQuizBtn.classList.remove('is-hidden');
            retryQuizBtn.classList.add('is-hidden');
            showAnswersBtn.classList.add('is-hidden');
            showAnswersBtn.textContent = 'عرض الإجابات';
            quizResults.classList.add('is-hidden');
        }

        function submitQuiz() {
            const answers = {};
            const lesson = course.lessons[currentLessonIndex];
            const quiz = courseManager.generateQuiz(courseId, lesson.id);
            
            quiz.forEach((question, qIndex) => {
                const selectedOption = document.querySelector(`input[name="question-${qIndex}"]:checked`);
                if (selectedOption) {
                    answers[qIndex] = parseInt(selectedOption.value);
                }
            });
            
            const result = courseManager.checkQuizAnswers(courseId, lesson.id, answers);
            
            // Show visual feedback for each answer
            quiz.forEach((question, qIndex) => {
                const options = document.querySelectorAll(`[data-question="${qIndex}"]`);
                
                options.forEach((option, oIndex) => {
                    option.classList.remove('correct', 'incorrect', 'selected');
                    
                    if (oIndex === question.correct) {
                        option.classList.add('correct');
                    } else if (answers[qIndex] === oIndex) {
                        option.classList.add('incorrect');
                    }
                });
                // Fill explanations but keep hidden until requested
                const exp = document.querySelector(`.quiz-explanation[data-explain-for="${qIndex}"]`);
                if (exp) {
                    const detail = result.details[qIndex];
                    exp.textContent = detail && detail.explanation ? `الشرح: ${detail.explanation}` : '';
                }
            });
            
            // Show results
            quizScore.textContent = `لقد أجبت بشكل صحيح على ${result.score} من ${result.total} أسئلة (${result.percentage}%)`;
            const hint = document.getElementById('quizThresholdHint');
            if (hint && typeof result.threshold === 'number') {
                hint.textContent = `النجاح يتطلب ${result.threshold}% فأكثر`;
            }
            const titleEl = document.getElementById('quizResultTitle');
            if (result.passed) {
                quizResults.firstElementChild.className = 'alert alert--success';
                if (titleEl) titleEl.textContent = 'ممتاز!';
                showAnswersBtn.classList.remove('is-hidden');
                markLessonCompleted();
            } else {
                quizResults.firstElementChild.className = 'alert alert--warning';
                if (titleEl) titleEl.textContent = 'يمكنك تحسين النتيجة';
                retryQuizBtn.classList.remove('is-hidden');
                showAnswersBtn.classList.remove('is-hidden');
            }
            quizResults.classList.remove('is-hidden');
            submitQuizBtn.classList.add('is-hidden');
        }

        function markLessonCompleted() {
            const lesson = course.lessons[currentLessonIndex];
            courseManager.markLessonCompleted(courseId, lesson.id);
            updateProgress();
            renderLessonsList();
        }

        function updateProgress() {
            const progress = courseManager.getProgressPercentage(courseId);
            const completed = course.lessons.filter(l => l.completed).length;
            const total = course.lessons.length;
            
            // Update progress ring
            const circumference = 2 * Math.PI * 36; // radius = 36
            const offset = circumference - (progress / 100) * circumference;
            progressRing.style.strokeDasharray = `${circumference - offset} ${offset}`;
            
            // Update text
            progressPercentage.textContent = `${progress}%`;
            completedLessonsEl.textContent = completed;

            updateCertificateUI(progress, completed, total);
        }

        function updateCertificateUI(progress, completed, total) {
            if (!certificateCard || typeof certificateManager === 'undefined') {
                return;
            }

            if (progress >= 100) {
                certificateCard.classList.remove('is-hidden');
                const existingCertificate = certificateManager.getCertificate(courseId);

                if (existingCertificate) {
                    certificateStatus.textContent = `تم إصدار الشهادة بتاريخ ${formatCertificateDate(existingCertificate.issuedAt)}.`;
                    certificateBtn.classList.add('is-hidden');
                    viewCertificateBtn.classList.remove('is-hidden');
                    certificateDetails.classList.remove('is-hidden');
                    certificateIdValue.textContent = existingCertificate.certificateId || '—';
                    certificateDateValue.textContent = formatCertificateDate(existingCertificate.issuedAt);
                    certificateNameValue.textContent = existingCertificate.userName || '—';
                } else {
                    certificateStatus.textContent = 'تهانينا! أكملت جميع الدروس ويمكنك إصدار شهادة الإتمام الرقمية الخاصة بك الآن.';
                    certificateBtn.classList.remove('is-hidden');
                    viewCertificateBtn.classList.add('is-hidden');
                    certificateDetails.classList.add('is-hidden');
                    certificateIdValue.textContent = '—';
                    certificateDateValue.textContent = '—';
                    certificateNameValue.textContent = '—';

                    if (!hasAnnouncedCompletion) {
                        if (typeof showMessage === 'function') {
                            showMessage('تهانينا! أصبحت مؤهلاً لإصدار شهادة إتمام الدورة.', 'success');
                        }
                        hasAnnouncedCompletion = true;
                    }
                }
            } else {
                certificateCard.classList.add('is-hidden');
            }
        }

        function formatCertificateDate(value) {
            if (!value) {
                return '—';
            }
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) {
                return '—';
            }
            return date.toLocaleDateString('ar-SA', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }

        function retryQuiz() {
            // Reset quiz state
            document.querySelectorAll('.quiz-option').forEach(option => {
                option.classList.remove('correct', 'incorrect', 'selected');
                option.querySelector('input').checked = false;
            });
            
            quizResults.classList.add('is-hidden');
            submitQuizBtn.classList.remove('is-hidden');
            retryQuizBtn.classList.add('is-hidden');
            showAnswersBtn.classList.add('is-hidden');
            document.querySelectorAll('.quiz-explanation').forEach(el => el.classList.add('is-hidden'));
            showAnswersBtn.textContent = 'عرض الإجابات';
        }

        function showAnswers() {
            // Toggle explanations visibility and button text
            const anyHidden = Array.from(document.querySelectorAll('.quiz-explanation'))
                .some(el => !el.textContent || el.classList.contains('is-hidden'));
            document.querySelectorAll('.quiz-explanation').forEach(el => {
                if (!el.textContent || el.textContent.trim().length === 0) return;
                if (anyHidden) {
                    el.classList.remove('is-hidden');
                } else {
                    el.classList.add('is-hidden');
                }
            });
            if (anyHidden) {
                showAnswersBtn.textContent = 'إخفاء الإجابات';
            } else {
                showAnswersBtn.textContent = 'عرض الإجابات';
            }
        }

        function openCertificateModal() {
            if (!certificateModal) {
                return;
            }

            prefillCertificateForm();
            certificateModal.classList.add('is-open');
            document.body.classList.add('has-modal-open');

            window.requestAnimationFrame(() => {
                certificateNameInput?.focus();
            });
        }

        function closeCertificateModal() {
            if (!certificateModal) {
                return;
            }

            certificateModal.classList.remove('is-open');
            document.body.classList.remove('has-modal-open');
        }

        function prefillCertificateForm() {
            if (!certificateNameInput || typeof certificateManager === 'undefined') {
                return;
            }

            const profile = certificateManager.getProfile();
            if (profile?.fullName) {
                certificateNameInput.value = profile.fullName;
            }
            if (certificateShareInput && typeof profile?.shareCertificates === 'boolean') {
                certificateShareInput.checked = profile.shareCertificates;
            }
        }

        function openCertificatePage(certificateData) {
            const params = new URLSearchParams({ course: courseId });
            if (certificateData?.certificateId) {
                params.set('certificateId', certificateData.certificateId);
            }
            window.open(`certificate.html?${params.toString()}`, '_blank', 'noopener');
        }

        function handleCertificateFormSubmit(event) {
            event.preventDefault();

            if (!certificateForm || typeof certificateManager === 'undefined') {
                return;
            }

            const fullName = certificateNameInput?.value.trim();
            if (!fullName) {
                certificateNameInput?.focus();
                return;
            }

            const completed = course.lessons.filter(l => l.completed).length;
            const shareRequested = certificateShareInput?.checked || false;
            const certificate = certificateManager.issueCertificate(courseId, {
                courseTitle: course.title,
                courseBadge: course.badge,
                userName: fullName,
                totalLessons: course.lessons.length,
                lessonsCompleted: completed,
                metadata: { shareRequested }
            });

            const existingProfile = certificateManager.getProfile() || {};

            certificateManager.updateProfile({
                fullName,
                preferredTrack: course.category,
                email: existingProfile.email || undefined,
                shareCertificates: shareRequested
            });

            closeCertificateModal();
            updateCertificateUI(100, completed, course.lessons.length);

            if (typeof showMessage === 'function') {
                showMessage('تم إصدار شهادتك بنجاح! يمكنك تنزيلها أو مشاركتها.', 'success');
            }

            openCertificatePage(certificate);
        }

        // Event listeners
        continueBtn.addEventListener('click', () => {
            // Find first incomplete lesson or current lesson
            const nextIncomplete = course.lessons.findIndex(lesson => !lesson.completed);
            loadLesson(nextIncomplete >= 0 ? nextIncomplete : 0);
        });

        prevLessonBtn.addEventListener('click', () => {
            if (currentLessonIndex > 0) {
                loadLesson(currentLessonIndex - 1);
            }
        });

        nextLessonBtn.addEventListener('click', () => {
            const lesson = course.lessons[currentLessonIndex];

            if (!lesson.completed) {
                showQuiz();
                return;
            }

            if (currentLessonIndex < course.lessons.length - 1) {
                loadLesson(currentLessonIndex + 1);
                return;
            }

            updateProgress();

            if (typeof certificateManager !== 'undefined' && certificateManager.hasCertificate(courseId)) {
                openCertificatePage(certificateManager.getCertificate(courseId));
            } else if (certificateCard) {
                certificateCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });

    submitQuizBtn.addEventListener('click', submitQuiz);
        retryQuizBtn.addEventListener('click', retryQuiz);
    showAnswersBtn.addEventListener('click', showAnswers);
        startQuizBtn.addEventListener('click', showQuiz);

        certificateBtn?.addEventListener('click', openCertificateModal);
        viewCertificateBtn?.addEventListener('click', () => {
            if (typeof certificateManager === 'undefined') {
                return;
            }
            const certificate = certificateManager.getCertificate(courseId);
            if (certificate) {
                openCertificatePage(certificate);
            } else {
                openCertificateModal();
            }
        });

        certificateForm?.addEventListener('submit', handleCertificateFormSubmit);

        document.querySelectorAll('[data-dismiss="certificateModal"]').forEach(element => {
            element.addEventListener('click', closeCertificateModal);
        });

        certificateModal?.addEventListener('click', event => {
            if (event.target === certificateModal) {
                closeCertificateModal();
            }
        });

        document.addEventListener('keydown', event => {
            if (event.key === 'Escape' && certificateModal?.classList.contains('is-open')) {
                closeCertificateModal();
            }
        });

        // Toggle lessons sidebar (mobile)
        lessonsToggle.addEventListener('click', () => {
            const collapsed = lessonsSidebar.classList.toggle('is-collapsed');
            lessonsToggle.setAttribute('aria-expanded', String(!collapsed));
            lessonsToggle.textContent = collapsed ? 'إظهار القائمة' : 'إخفاء القائمة';
        });

        // Initialize the course when page loads
        document.addEventListener('DOMContentLoaded', initializeCourse);
    </script>
</body>
</html>